<!DOCTYPE html>
<html>
<head>
  <title>astro-grid</title>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
  <style type="text/css">
    #display {
      width:650;
      height:650;
      float:left;
    }
    #links {

      float:right;
    }
  </style>
</head>
<body style="background-color: black">
  <div id="display" style="">
  </div>
  <div id="links">
  </div>
  <script>
    d3.json("data/data.json", function(error, data) {
      var width = 650;
      var height = 650;

      var canvas = d3.select("#display")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      var maxCount = d3.max(data, function(d){ return d.Count; })

      var colourScale = d3.scale.log()
        .domain([1,maxCount])
        .range([0,255]);

      var axisScale = d3.scale.linear()
        .domain([0,6])
        .range([45, 645]);

      var yaxis = canvas.selectAll("line.horizontalGrid").data(axisScale.ticks(6)).enter();
      yaxis.append("line")
        .attr({
            "class":"horizontalGrid",
            "x1" : 35,
            "x2" : 45,
            "y1" : function(d) { return axisScale(d); },
            "y2" : function(d) { return axisScale(d); },
            "fill" : "black",
            "shape-rendering" : "crispEdges",
            "stroke" : "white",
            "stroke-width" : "1px"
        });
      yaxis.append("text")
        .attr("class", "ymark")
        .attr("text-anchor", "middle")
        .attr("x", 30)
        .attr("y", function(d) { return axisScale(d) + 3; })
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("stroke", "white")
        .attr("fill", "white")
        .text(function(d) {
          return d;
        });

      var xaxis = canvas.selectAll("line.verticalGrid").data(axisScale.ticks(6)).enter();
      xaxis.append("line")
        .attr({
            "class":"verticalGrid",
            "x1" : function(d) { return axisScale(d); },
            "x2" : function(d) { return axisScale(d); },
            "y1" : 35,
            "y2" : 45,
            "fill" : "black",
            "shape-rendering" : "crispEdges",
            "stroke" : "white",
            "stroke-width" : "1px"
        });
      xaxis.append("text")
        .attr("class", "xmark")
        .attr("text-anchor", "middle")
        .attr("x", function(d) { return axisScale(d); })
        .attr("y", 34)
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("stroke", "white")
        .attr("fill", "white")
        .text(function(d) {
          return d;
        });

      // Axis labels
      canvas.append("text")
        .attr("class", "xlabel")
        .attr("text-anchor", "middle")
        .attr("x", width / 2)
        .attr("y", 6)
        .attr("dy", ".75em")
        .attr("font-family", "sans-serif")
        .attr("stroke", "white")
        .attr("fill", "white")
        .text("Perihelion (Closest distance from sun) (AU)");

      canvas.append("text")
        .attr("class", "ylabel")
        .attr("text-anchor", "middle")
        .attr("y", 6)
        .attr("x", -1 * (height / 2))
        .attr("dy", ".75em")
        .attr("transform", "rotate(-90)")
        .attr("font-family", "sans-serif")
        .attr("stroke", "white")
        .attr("fill", "white")
        .text("Apohelion (Furthest distance from sun) (AU)");

      // The actual data display.
      canvas.selectAll("rects")
        .data(data)
        .enter().append("svg:rect")
        .attr("x", function(d) { return (d.X * 10) + 45; })
        .attr("y", function(d) { return (d.Y * 10) + 45; })
        .attr("width", function(d) { return 10; })
        .attr("height", function(d) { return 10; })
        .attr("fill", function(d) { return d3.rgb(0, 0, colourScale(d.Count));})
        .attr("stroke", "dark gray")
        .on("click", function(d) {
          console.log("data/" + d.X + "/" +d.Y + ".txt");

          ga('send', 'event', 'grid', 'click', d.X + ":" + d.Y);

          d3.csv("data/" + d.X + "/" +d.Y + ".txt", function(data) {
              console.log("result");
              var links = d3.select("#links");
              console.log("links");
              var linkElements = links.selectAll("a.link")
                .data(data);
              console.log("data");
              linkElements.remove();
              linkElements.enter()
                .append("a")
                .attr("class", "link")
                .attr("href", function(d) {
                  return "http://ssd.jpl.nasa.gov/sbdb.cgi?sstr=" + d.id;
                })
                .on("click", function(d) { trackOutboundLink("http://ssd.jpl.nasa.gov/sbdb.cgi?sstr=" + d.id) })

                .text(function(d) { return d.id; })
                .append("br");
            });
        })
        .append("svg:title")
          .text(function(d) {
            var result = "X: " + d.StartX + " Y: " + d.StartY + " Count: " +d.Count;
            if (d.Special != "") {
              result = result + " (" + d.Special + ")";
            }
            return result;
          });

    });

  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-38378302-3', 'auto');
    ga('send', 'pageview');

    var trackOutboundLink = function(url) {
       ga('send', 'event', 'outbound', 'click', url, {'hitCallback':
         function () {
         document.location = url;
         }
       });
    }

  </script>
</body>
</html>
