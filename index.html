<!DOCTYPE html>
<html>
<head>
  <title>astro-grid</title>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
  <style type="text/css">
    body {
      background-color: black;
      color:white;
    }
    #header {
      color: white;
    }

    #body {
      width: 100%;
    }

    #display {
      width:650;
      height:650;
      float:left;
    }

    #links {
      float:right;
    }

    .footer {
      float:left;
      width:100%;
      margin-top: 10px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div id="header">
    X:<select id="xAxisSelect" name="xAxisSelect"></select>
    Y:<select id="yAxisSelect" name="yAxisSelect"></select>
    Colour:<select id="colourSelect" name="colourSelect">
      <option value="red">Red</option>
      <option value="green" default="true">Green</option>
      <option value="blue">Blue</option>
      <option value="gray">Gray</option>
    </select>
  </div>
  <div id="body">
    <div id="display">
    </div>
    <div id="links">
    </div>
  </div>
  <div class="footer">
    Data created from <a href="http://minorplanetcenter.net/">Minor Planet Centre</a> Orbit files. Avaible <a href="http://minorplanetcenter.net/iau/MPCORB.html">here</a><br>
    Processed by Wil Selwood using code avaible on <a href="https://github.com/wselwood/astro-grid">github</a>
  </div>

  <script>

    var onAxisChange = function() {
      var xSelect = document.getElementById("xAxisSelect");
      var ySelect = document.getElementById("yAxisSelect");
      var colourSelect = document.getElementById("colourSelect");

      var xAxisName = xSelect.options[xSelect.selectedIndex].value;
      var yAxisName = ySelect.options[ySelect.selectedIndex].value;
      var colourValue = colourSelect.options[colourSelect.selectedIndex].value;

      window.location.hash = xAxisName + "/" + yAxisName + "/" + colourValue;

      var dimXMinValue = xSelect.options[xSelect.selectedIndex].__data__.min;
      var dimXMaxValue = xSelect.options[xSelect.selectedIndex].__data__.max;
      var dimYMinValue = ySelect.options[ySelect.selectedIndex].__data__.min;
      var dimYMaxValue = ySelect.options[ySelect.selectedIndex].__data__.max;

      var inputValue = "data/" + xAxisName + "/" + yAxisName + "/data.json"
      d3.json(inputValue, function(error, chartData) {
        var maxX = d3.max(chartData, function(d) { return d.x; });
        var maxY = d3.max(chartData, function(d) { return d.y; });
        var maxCount = d3.max(chartData, function(d) { return d.c; });

        var width = (maxX * 10) + 45;
        var height = (maxY * 10) + 45;

        var colourScale = d3.scale.log()
          .domain([1,maxCount])
          .range([1,255]);

        var mapColour = function(value) {
          var colourSelect = document.getElementById("colourSelect");
          var colourEntry = colourSelect.options[colourSelect.selectedIndex].value;

          if (colourEntry == "red") {
            return d3.rgb(colourScale(value), 0, 0);
          } else if (colourEntry == "green") {
            return d3.rgb(0, colourScale(value), 0);
          } else if (colourEntry == "blue") {
            return d3.rgb(0, 0, colourScale(value));
          } else {
            var colour = colourScale(value);
            return d3.rgb(colour, colour, colour);
          }
        };

        var xScale = d3.scale.linear()
          .domain([dimXMinValue, dimXMaxValue])
          .range([45, width]);

        var yScale = d3.scale.linear()
            .domain([dimYMinValue, dimYMaxValue])
            .range([45, height]);

        d3.select("#display").select("svg").remove();

        var canvas = d3.select("#display")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        var yaxis = canvas.selectAll("line.horizontalGrid").data(yScale.ticks(6));
        yaxis.remove();
        yaxis.enter().append("line")
          .attr({
              "class":"horizontalGrid",
              "x1" : 35,
              "x2" : 45,
              "y1" : function(d) { return yScale(d); },
              "y2" : function(d) { return yScale(d); },
              "fill" : "black",
              "shape-rendering" : "crispEdges",
              "stroke" : "white",
              "stroke-width" : "1px"
          });
        yaxis.enter().append("text")
          .attr("class", "ymark")
          .attr("text-anchor", "middle")
          .attr("x", 30)
          .attr("y", function(d) { return yScale(d) + 3; })
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("stroke", "white")
          .attr("fill", "white")
          .text(function(d) {
            return d;
          });

        var xaxis = canvas.selectAll("line.verticalGrid").data(xScale.ticks(6));
        xaxis.remove();
        xaxis.enter().append("line")
          .attr({
              "class":"verticalGrid",
              "x1" : function(d) { return xScale(d); },
              "x2" : function(d) { return xScale(d); },
              "y1" : 35,
              "y2" : 45,
              "fill" : "black",
              "shape-rendering" : "crispEdges",
              "stroke" : "white",
              "stroke-width" : "1px"
          });
        xaxis.enter().append("text")
          .attr("class", "xmark")
          .attr("text-anchor", "middle")
          .attr("x", function(d) { return xScale(d); })
          .attr("y", 34)
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("stroke", "white")
          .attr("fill", "white")
          .text(function(d) {
            return d;
          });

        var rectangles = canvas.selectAll("rects")
          .data(chartData);

        rectangles.remove();

        rectangles.enter()
          .append("svg:rect")
          .attr("class", "rects")
          .attr("x", function(d) { return (d.x * 10) + 45; })
          .attr("y", function(d) { return (d.y * 10) + 45; })
          .attr("width", 10)
          .attr("height", 10)
          .attr("fill", function(d) { return mapColour(d.c);})
          .attr("stroke", "dark gray")
          .append("svg:title")
          .text(function(d) {
            return xAxisName + ": " + d.sx + " " + yAxisName + ": " + d.sy + " Count: " +d.c;
          });

      })
    }

    d3.json("data/dimensions.json", function(error, dimensionData) {
      var xOptions = d3.select("#xAxisSelect").selectAll("option")
        .data(dimensionData)
        .enter()
        .append("option")
        .attr("value", function(d) { return d.n })
        .text(function(d) { return d.n });

      var yOptions = d3.select("#yAxisSelect").selectAll("option")
        .data(dimensionData)
        .enter()
        .append("option")
        .attr("value", function(d) { return d.n })
        .text(function(d) { return d.n });

      d3.select("#xAxisSelect").on("change", onAxisChange);
      d3.select("#yAxisSelect").on("change", onAxisChange);
      d3.select("#colourSelect").on("change", onAxisChange);

      if (window.location.hash) {
        if (window.location.hash.indexOf("/") !== -1) {
          var parts = window.location.hash.split("/")

          document.getElementById('xAxisSelect').value = parts[0].substring(1)
          document.getElementById('yAxisSelect').value = parts[1]

          if (parts[2]) {
            document.getElementById('colourSelect').value = parts[2]
          }
        }
      }
      onAxisChange();
    });
  </script>
</body>
</html>
